name: "MiNiFi-CPP CI"
on: [push, pull_request, workflow_dispatch]
env:
  DOCKER_CMAKE_FLAGS: -DDOCKER_VERIFY_THREAD=3 -DUSE_SHARED_LIBS= -DSTRICT_GSL_CHECKS=AUDIT -DCI_BUILD=ON -DENABLE_AWS=ON -DENABLE_KAFKA=ON -DENABLE_MQTT=ON -DENABLE_AZURE=ON -DENABLE_SQL=ON \
    -DENABLE_SPLUNK=ON -DENABLE_GCP=ON -DENABLE_OPC=ON -DENABLE_PYTHON_SCRIPTING=ON -DENABLE_LUA_SCRIPTING=ON -DENABLE_KUBERNETES=ON -DENABLE_TEST_PROCESSORS=ON -DENABLE_PROMETHEUS=ON \
    -DENABLE_ELASTICSEARCH=ON -DENABLE_GRAFANA_LOKI=ON -DENABLE_COUCHBASE=ON -DENABLE_LLAMACPP=ON -DDOCKER_BUILD_ONLY=ON -DMINIFI_PERFORMANCE_TESTS=ON
  SCCACHE_GHA_ENABLE: true
  CCACHE_DIR: ${{ GITHUB.WORKSPACE }}/.ccache
jobs:
  ubuntu_22_04_clang_arm:
    name: "Ubuntu 22.04 clang aarch64"
    runs-on: ubuntu-22.04-arm
    timeout-minutes: 240
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: get-changed-files
        run: |
          if [[ -n "${{github.event.pull_request.base.sha}}" ]]; then
            base_commit=${{github.event.pull_request.base.sha}}
          else
            base_commit=${{github.sha}}~
          fi
          git fetch origin ${base_commit}
          head_commit=${{github.sha}}
          echo "files=$(git diff --name-only --diff-filter=ACMRT ${base_commit} ${head_commit} | xargs)" >> $GITHUB_OUTPUT
      - name: show-changed-files
        run: |
          echo "changed files: ${{steps.get-changed-files.outputs.files}}"
